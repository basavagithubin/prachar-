{% extends 'core/base.html' %}
{% load custom_tags %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-yellow-100 via-white to-orange-100 px-6 py-12">
  <div class="max-w-[95rem] mx-auto">
    <h1 class="text-5xl font-bold text-center text-orange-700 mb-12 drop-shadow-sm tracking-tight">
      📖 FOE Registration Dashboard
    </h1>

    <!-- Search and Download Bar -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-10">
      <form method="GET" class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
        <input
          type="text"
          name="search"
          value="{{ request.GET.search }}"
          placeholder="🔍 Search name, phone, volunteer..."
          class="w-full sm:w-96 px-6 py-3 rounded-lg border border-orange-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
        />
        <button
          type="submit"
          class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold shadow"
        >
          Search
        </button>
      </form>
      <a href="{% url 'export_candidates_excel' %}" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg shadow font-medium">
        ⬇️ Download Excel
      </a>
    </div>

    <!-- Table View -->
    <div class="overflow-x-auto bg-white border border-orange-200 rounded-xl shadow">
      <table class="w-full text-sm text-gray-800">
        <thead class="text-xs uppercase bg-orange-100 text-orange-900">
          <tr class="text-center">
            <th class="px-4 py-4">Name</th>
            <th class="px-4 py-4">Email</th>
            <th class="px-4 py-4">Phone</th>
            <th class="px-4 py-4">WhatsApp</th>
            <th class="px-4 py-4">Reg. Date</th>
            <th class="px-4 py-4">Language</th>
            <th class="px-4 py-4">Volunteer</th>
            <th class="px-4 py-4">Assign Volunteer</th>
            <th class="px-4 py-4">Attendance</th>
            <th class="px-4 py-4">Follow-Up</th>
            <th class="px-4 py-4">Status</th>
            <th class="px-4 py-4">Level</th>
            <th class="px-4 py-4">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-orange-50">
          {% for candidate in candidates %}
          <tr class="hover:bg-orange-50 transition text-center">
            <td class="px-4 py-3 font-semibold text-left">{{ candidate.name }}</td>
            <td class="px-4 py-3 truncate max-w-[180px]" title="{{ candidate.email }}">{{ candidate.email }}</td>
            <td class="px-4 py-3">{{ candidate.phone }}</td>
            <td class="px-4 py-3">
              {% if candidate.phone %}
              <a href="https://wa.me/{{ candidate.phone|cut:' '|cut:'-'|cut:'('|cut:')' }}" target="_blank" class="text-green-600 text-xl">📱</a>
              {% endif %}
            </td>
            <td class="px-4 py-3">{{ candidate.registration_date|date:"M d, Y" }}</td>
            <td class="px-4 py-3">{{ candidate.mother_tongue }}</td>
            <td class="px-4 py-3">
              {% if candidate.assigned_volunteer %}
              <span class="text-green-700 font-medium">{{ candidate.assigned_volunteer.name }}</span>
              {% else %}<span class="text-gray-400 italic">Not Assigned</span>{% endif %}
            </td>
            <td class="px-4 py-3">
              <form method="POST">{% csrf_token %}
                <input type="hidden" name="candidate_id" value="{{ candidate.id }}">
                <select name="volunteer_id" class="border border-orange-300 rounded px-2 py-1 text-sm w-full">
                  <option value="">Select</option>
                  {% for volunteer in volunteers %}
                  <option value="{{ volunteer.id }}">{{ volunteer.name }}</option>
                  {% endfor %}
                </select>
                <button class="w-full mt-1 bg-orange-600 text-white py-1 rounded hover:bg-orange-700 text-xs">Assign</button>
              </form>
            </td>
            <td class="px-4 py-3">
              {% if candidate.attended %}
              <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">✔ Attended</span>
              {% else %}
              <form method="POST">{% csrf_token %}
                <input type="hidden" name="attendance_candidate_id" value="{{ candidate.id }}">
                <button class="bg-green-600 text-white px-3 py-1 text-xs rounded hover:bg-green-700">Mark</button>
              </form>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if candidate.followed_up %}
              <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">✔ Followed-Up</span>
              {% else %}
              <form method="POST">{% csrf_token %}
                <input type="hidden" name="follow_up_candidate_id" value="{{ candidate.id }}">
                <button class="bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700">Mark</button>
              </form>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              <form method="POST" class="space-y-1">{% csrf_token %}
                <input type="hidden" name="follow_up_status_candidate_id" value="{{ candidate.id }}">
                <select name="follow_up_status" class="border border-orange-300 rounded px-2 py-1 text-xs w-full">
                  <option value="">Status</option>
                  {% for key, label in follow_up_status_choices %}
                  <option value="{{ key }}" {% if candidate.follow_up_status == key %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <input type="date" name="follow_up_status_date" value="{{ candidate.follow_up_status_date|date:'Y-m-d' }}" class="w-full border border-orange-300 rounded px-2 py-1 text-xs">
                <button class="bg-blue-700 hover:bg-blue-800 text-white px-2 py-1 w-full rounded text-xs">Update</button>
              </form>
            </td>
            <td class="px-4 py-3">
              <form method="POST">{% csrf_token %}
                <input type="hidden" name="level_candidate_id" value="{{ candidate.id }}">
                <select name="level" class="border border-orange-300 rounded px-2 py-1 text-xs w-full">
                  <option value="">Level</option>
                  <option value="L1" {% if candidate.level == "L1" %}selected{% endif %}>L1</option>
                  <option value="L2" {% if candidate.level == "L2" %}selected{% endif %}>L2</option>
                  <option value="L3" {% if candidate.level == "L3" %}selected{% endif %}>L3</option>
                  <option value="L4" {% if candidate.level == "L4" %}selected{% endif %}>L4</option>
                </select>
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 mt-1 w-full rounded text-xs">Update</button>
              </form>
            </td>
            <td class="px-4 py-3">
              <form method="POST" onsubmit="return confirm('Are you sure you want to delete this candidate?');">
                {% csrf_token %}
                <input type="hidden" name="delete_candidate_id" value="{{ candidate.id }}">
                <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">Delete</button>
              </form>
              <a href="{% url 'candidate_detail' candidate.id %}" title="View Details" class="block text-xs text-orange-600 mt-1 hover:underline">👁 View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="13" class="text-center text-gray-400 py-6 italic">🙏 No candidates found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- Pagination Controls -->
<div class="flex justify-center mt-8 space-x-2">
  {% if candidates.has_previous %}
    <a href="?{% if query %}search={{ query }}&{% endif %}page=1" class="px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">« First</a>
    <a href="?{% if query %}search={{ query }}&{% endif %}page={{ candidates.previous_page_number }}" class="px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">‹ Prev</a>
  {% endif %}

  <span class="px-4 py-1 bg-orange-500 text-white rounded">
    Page {{ candidates.number }} of {{ candidates.paginator.num_pages }}
  </span>

  {% if candidates.has_next %}
    <a href="?{% if query %}search={{ query }}&{% endif %}page={{ candidates.next_page_number }}" class="px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">Next ›</a>
    <a href="?{% if query %}search={{ query }}&{% endif %}page={{ candidates.paginator.num_pages }}" class="px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">Last »</a>
  {% endif %}
</div>

      
    </div>

    <!-- Footer Links -->
    <div class="mt-10 flex justify-end gap-4">
      <a href="{% url 'deleted_candidates' %}" class="bg-gray-700 hover:bg-gray-800 text-white px-6 py-2 rounded-lg shadow">🗑 Deleted</a>
      <a href="{% url 'follow_up_report' %}" class="bg-orange-700 hover:bg-orange-800 text-white px-6 py-2 rounded-lg shadow">📘 Follow-Up Report</a>
    </div>
  </div>
</div>
{% endblock %}
